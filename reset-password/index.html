<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const supabase = createClient(
    "https://kqmczcojsygukexmkofp.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxbWN6Y29qc3lndWtleG1rb2ZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNDEzMjQsImV4cCI6MjA3MjkxNzMyNH0.JfN2L-GCCOHE6k8ZsoX6YZaVIRjUCbaEiXU_TzXpBbQ"
  );

  const passwordInput = document.getElementById("password");
  const password2Input = document.getElementById("password2");
  const resetBtn = document.getElementById("resetBtn");
  const msg = document.getElementById("msg");

  // ğŸ”„ VÃ©rifie ou crÃ©e une session Ã  partir du lien de rÃ©cupÃ©ration
  async function initSession() {
    try {
      const params = new URLSearchParams(window.location.search);
      const hashParams = new URLSearchParams(window.location.hash.substring(1));

      const code = params.get("code");
      const accessToken = hashParams.get("access_token");
      const refreshToken = hashParams.get("refresh_token");
      const type = hashParams.get("type");

      // ğŸ”¹ Cas 1 : lien avec #access_token (ancien comportement)
      if (type === "recovery" && accessToken) {
        const { error } = await supabase.auth.setSession({
          access_token: accessToken,
          refresh_token: refreshToken,
        });
        if (error) throw error;
        return true;
      }

      // ğŸ”¹ Cas 2 : lien avec ?code= (comportement standard actuel Supabase)
      if (code) {
        const { data, error } = await supabase.auth.exchangeCodeForSession(code);
        if (error) throw error;

        // Stocke la session localement pour Ã©viter de la perdre sur reload
        if (data.session) {
          localStorage.setItem("supabaseSession", JSON.stringify(data.session));
        }

        return true;
      }

      // Aucun token trouvÃ©
      throw new Error("Aucun token de rÃ©cupÃ©ration trouvÃ©.");
    } catch (e) {
      console.error("Erreur d'initialisation de session :", e);
      msg.textContent =
        "âŒ Lien invalide ou expirÃ©. Veuillez redemander un email de rÃ©initialisation.";
      msg.classList.add("error");
      resetBtn.disabled = true;
      return false;
    }
  }

  // ğŸ§® VÃ©rifie la force du mot de passe
  function validatePasswordStrength(pwd) {
    const len = pwd.length >= 8;
    const maj = /[A-Z]/.test(pwd);
    const num = /\d/.test(pwd);
    const spec = /[!@#$%^&*]/.test(pwd);

    document.getElementById("len").textContent =
      (len ? "âœ…" : "ğŸ”¸") + " Au moins 8 caractÃ¨res";
    document.getElementById("maj").textContent =
      (maj ? "âœ…" : "ğŸ”¸") + " Une majuscule";
    document.getElementById("num").textContent =
      (num ? "âœ…" : "ğŸ”¸") + " Un chiffre";
    document.getElementById("spec").textContent =
      (spec ? "âœ…" : "ğŸ”¸") + " Un caractÃ¨re spÃ©cial (!@#...)";

    return len && maj && num && spec;
  }

  passwordInput.addEventListener("input", () =>
    validatePasswordStrength(passwordInput.value)
  );

  // ğŸš€ Gestion du clic sur "RÃ©initialiser"
  resetBtn.addEventListener("click", async () => {
    const pwd1 = passwordInput.value.trim();
    const pwd2 = password2Input.value.trim();

    msg.className = "msg";

    if (!pwd1 || !pwd2) {
      msg.textContent = "Veuillez remplir les deux champs.";
      msg.classList.add("error");
      return;
    }

    if (pwd1 !== pwd2) {
      msg.textContent = "Les mots de passe ne correspondent pas.";
      msg.classList.add("error");
      return;
    }

    if (!validatePasswordStrength(pwd1)) {
      msg.textContent = "Le mot de passe ne respecte pas les critÃ¨res.";
      msg.classList.add("error");
      return;
    }

    // ğŸ”‘ Assure-toi que la session est active
    const ok = await initSession();
    if (!ok) return;

    // ğŸ” Mise Ã  jour du mot de passe
    const { error } = await supabase.auth.updateUser({ password: pwd1 });
    if (error) {
      msg.textContent = "Erreur : " + error.message;
      msg.classList.add("error");
    } else {
      msg.textContent =
        "âœ… Mot de passe mis Ã  jour avec succÃ¨s ! Vous pouvez maintenant vous reconnecter.";
      msg.classList.add("success");
      resetBtn.disabled = true;
    }
  });

  // ğŸª„ Initialise la session automatiquement au chargement
  // (utile si la page est rechargÃ©e aprÃ¨s clic sur le lien)
  window.addEventListener("DOMContentLoaded", initSession);
</script>
