<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  window.addEventListener("DOMContentLoaded", async () => {
    console.log("‚úÖ DOM charg√©, ex√©cution du script.");

    const supabase = createClient(
      "https://kqmczcojsygukexmkofp.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxbWN6Y29qc3lndWtleG1rb2ZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNDEzMjQsImV4cCI6MjA3MjkxNzMyNH0.JfN2L-GCCOHE6k8ZsoX6YZaVIRjUCbaEiXU_TzXpBbQ"
    );

    const passwordInput = document.getElementById("password");
    const password2Input = document.getElementById("password2");
    const resetBtn = document.getElementById("resetBtn");
    const msg = document.getElementById("msg");

    if (!passwordInput || !password2Input || !resetBtn || !msg) {
      console.error("‚ùå Les √©l√©ments HTML ne sont pas pr√©sents dans la page !");
      return;
    }

    async function initSession() {
      try {
        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");
        if (!code) {
          msg.textContent = "Lien invalide ou expir√©.";
          msg.classList.add("error");
          return false;
        }
        const { data, error } = await supabase.auth.exchangeCodeForSession(code);
        if (error) throw error;
        console.log("‚úÖ Session active :", data);
        msg.textContent = "‚úÖ Session active. Vous pouvez r√©initialiser votre mot de passe.";
        msg.classList.add("success");
        return true;
      } catch (e) {
        console.error("Erreur d'init session :", e);
        msg.textContent = "‚ùå Lien invalide ou expir√©.";
        msg.classList.add("error");
        return false;
      }
    }

    function validatePasswordStrength(pwd) {
      const len = pwd.length >= 8;
      const maj = /[A-Z]/.test(pwd);
      const num = /\d/.test(pwd);
      const spec = /[!@#$%^&*]/.test(pwd);
      document.getElementById("len").textContent =
        (len ? "‚úÖ" : "üî∏") + " Au moins 8 caract√®res";
      document.getElementById("maj").textContent =
        (maj ? "‚úÖ" : "üî∏") + " Une majuscule";
      document.getElementById("num").textContent =
        (num ? "‚úÖ" : "üî∏") + " Un chiffre";
      document.getElementById("spec").textContent =
        (spec ? "‚úÖ" : "üî∏") + " Un caract√®re sp√©cial (!@#...)";
      return len && maj && num && spec;
    }

    passwordInput.addEventListener("input", () =>
      validatePasswordStrength(passwordInput.value)
    );

    resetBtn.addEventListener("click", async () => {
      const pwd1 = passwordInput.value.trim();
      const pwd2 = password2Input.value.trim();
      msg.className = "msg";
      if (!pwd1 || !pwd2) {
        msg.textContent = "Veuillez remplir les deux champs.";
        msg.classList.add("error");
        return;
      }
      if (pwd1 !== pwd2) {
        msg.textContent = "Les mots de passe ne correspondent pas.";
        msg.classList.add("error");
        return;
      }
      if (!validatePasswordStrength(pwd1)) {
        msg.textContent = "Le mot de passe ne respecte pas les crit√®res.";
        msg.classList.add("error");
        return;
      }
      const ok = await initSession();
      if (!ok) return;
      const { error } = await supabase.auth.updateUser({ password: pwd1 });
      if (error) {
        msg.textContent = "Erreur : " + error.message;
        msg.classList.add("error");
      } else {
        msg.textContent =
          "‚úÖ Mot de passe mis √† jour avec succ√®s ! Vous pouvez maintenant vous reconnecter.";
        msg.classList.add("success");
        resetBtn.disabled = true;
      }
    });

    // Initialise automatiquement la session si lien contient ?code=
    await initSession();
  });
</script>
